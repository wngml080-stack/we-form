# We:form PRD (Product Requirements Document)

> **최종 업데이트**: 2025-12-30
> **버전**: 1.0
> **목적**: 개발 로드맵 수립을 위한 기능 명세서

---

## 1. 프로젝트 개요

### 1.1 제품 정의
**We:form**은 피트니스 센터(헬스장/필라테스/PT 센터)를 위한 **멀티테넌시 ERP SaaS** 플랫폼입니다.

### 1.2 핵심 가치
- **멀티테넌시**: 회사(Company) → 지점(Gym) 구조로 데이터 격리
- **역할 기반 접근 제어**: system_admin / company_admin / admin / staff 4단계
- **통합 관리**: 회원, 스케줄, 출석, 급여, 매출을 하나의 플랫폼에서 관리

### 1.3 기술 스택
| 영역 | 기술 |
|------|------|
| Frontend | Next.js 16, TypeScript, Tailwind CSS 4, shadcn/ui |
| Backend | Next.js API Routes, Supabase (PostgreSQL) |
| 인증 | Clerk (OAuth) |
| 보안 | Row Level Security (RLS) |
| 배포 | Vercel |

---

## 2. 사용자 역할 및 권한

| 역할 | 설명 | 접근 범위 |
|------|------|----------|
| `system_admin` | 시스템 관리자 | 모든 회사/지점 |
| `company_admin` | 본사 관리자 | 소속 회사의 모든 지점 |
| `admin` | 지점 관리자 | 소속 지점만 |
| `staff` | 일반 직원/강사 | 본인 데이터만 |

---

## 3. 기능 현황 및 로드맵

### 범례
- ✅ **완료**: 기능 구현 완료
- 🔄 **부분 구현**: 기본 기능은 있으나 개선 필요
- ❌ **미구현**: 아직 개발되지 않음
- 🎯 **우선순위**: P1(높음) / P2(중간) / P3(낮음)

---

## 4. 회원 관리 (Members)

### 4.1 현재 구현 상태: ✅ 완료 (90%)

#### 구현된 기능
| 기능 | 상태 | 설명 |
|------|------|------|
| 회원 CRUD | ✅ | 생성, 조회, 수정, 삭제 |
| 회원권 판매 | ✅ | 신규/재등록/연장 구분, 결제 기록 |
| 부가상품 판매 | ✅ | 락커, 운동복, 양말 등 |
| 회원 검색/필터 | ✅ | 이름, 연락처, 상태별 필터링 |
| 회원 상태 관리 | ✅ | active/paused/expired 상태 전환 |
| 회원권 홀딩 | ✅ | 홀딩 기간, 시작일, 사유 기록 |
| 대량 작업 | ✅ | 선택된 회원 일괄 삭제, 트레이너 할당 |
| Excel 가져오기/내보내기 | ✅ | 대량 등록 및 데이터 추출 |
| 활동 로그 | ✅ | 모든 변경사항 자동 기록 |
| TanStack Table | ✅ | 정렬, 컬럼 관리, 행 선택 |

#### 미구현 기능
| 기능 | 우선순위 | 설명 |
|------|----------|------|
| 회원권 양도 | 🎯 P1 | 다른 회원에게 회원권 이전 |
| 회원 통합/병합 | P3 | 중복 회원 데이터 병합 |
| 회원 포털 | P3 | 회원 전용 앱/웹 (출석 확인, 예약) |

### 4.2 회원권 양도 기능 요구사항 (신규)

```
기능명: 회원권 양도
우선순위: P1

요구사항:
1. 양도 대상 선택
   - 기존 회원 검색 및 선택
   - 신규 회원 등록 후 양도

2. 양도 정보 기록
   - 양도인 (원래 회원)
   - 양수인 (새 회원)
   - 양도일
   - 양도 사유
   - 잔여 횟수/기간 이전

3. 양도 수수료 (선택)
   - 수수료 금액 설정
   - 결제 기록 생성

4. 이력 관리
   - 양도 전/후 상태 기록
   - 활동 로그에 양도 기록

API 엔드포인트:
POST /api/admin/members/[id]/membership/transfer
```

---

## 5. 스케줄/출석 관리 (Schedule/Attendance)

### 5.1 현재 구현 상태: 🔄 부분 구현 (70%)

#### 구현된 기능
| 기능 | 상태 | 설명 |
|------|------|------|
| 스케줄 캘린더 | ✅ | FullCalendar 기반, 월/주/일 뷰 |
| 스케줄 CRUD | ✅ | PT 수업 등록, 수정, 삭제 |
| 스케줄 타입 | ✅ | inside/outside/weekend/holiday 구분 |
| 출석 체크 | ✅ | 완료/노쇼/취소 상태 처리 |
| 직원별 필터링 | ✅ | 강사별 스케줄 조회 |
| 회원 연결 | ✅ | 스케줄에 회원 할당 |

#### 미구현/개선 필요 기능
| 기능 | 우선순위 | 설명 |
|------|----------|------|
| 월간 보고서 제출/승인 | 🎯 P1 | 강사가 월간 스케줄 제출, 관리자 승인 |
| 보고서 승인 후 잠금 | 🎯 P1 | 승인된 스케줄 수정 불가 |
| 반복 스케줄 | P2 | 매주 같은 시간 자동 생성 |
| 스케줄 충돌 감지 | P2 | 동일 시간 중복 예약 방지 |
| 대기열 관리 | P3 | 예약 대기 회원 관리 |

### 5.2 월간 보고서 기능 요구사항

```
기능명: 월간 스케줄 보고서
우선순위: P1

현재 상태:
- monthly_schedule_reports 테이블 존재
- 기본 API 구현 (/api/schedule/submit, /api/schedule/approve)
- 프론트엔드 UI 미완성

요구사항:
1. 강사(staff) 기능
   - 본인의 월간 스케줄 확인
   - 보고서 제출 버튼
   - 제출 상태 확인 (draft/submitted/approved/rejected)

2. 관리자(admin) 기능
   - 제출된 보고서 목록 조회
   - 보고서 상세 확인 (통계 포함)
   - 승인/반려 처리
   - 반려 시 사유 입력

3. 승인 후 처리
   - 해당 월의 schedules.is_locked = true
   - 급여 계산에 반영

UI 위치: /admin/reports
```

---

## 6. 급여 관리 (Salary)

### 6.1 현재 구현 상태: 🔄 부분 구현 (60%)

#### 구현된 기능
| 기능 | 상태 | 설명 |
|------|------|------|
| 월별 PT 실적 집계 | ✅ | 직원별 근무내/외/주말/공휴일 통계 |
| 급여 템플릿 관리 | ✅ | 템플릿 CRUD, 15개 프리셋 규칙 |
| 직원 급여 설정 | ✅ | 템플릿 할당, 개인 매개변수 설정 |
| 급여 계산 | ✅ | 5가지 계산 타입 (fixed/hourly/percentage/tiered) |
| 급여대장 Excel | ✅ | 계산 결과 내보내기 |

#### 미구현/개선 필요 기능
| 기능 | 우선순위 | 설명 |
|------|----------|------|
| 세금/공제 계산 | 🎯 P1 | 4대보험, 소득세 자동 계산 |
| 급여 명세서 생성 | 🎯 P1 | 개인별 급여 명세서 PDF |
| 전월 비교 분석 | 🎯 P2 | 전월 대비 증감액/증감률 |
| FC 레벨 시스템 | P2 | FC 직원 레벨별 인센티브 |
| 급여 계산 API | P2 | 서버사이드 계산 (현재 클라이언트) |
| 계산 이력 추적 | P2 | 언제, 누가 계산했는지 기록 |
| 대량 데이터 최적화 | P3 | 100명+ 직원 처리 성능 개선 |

### 6.2 세금/공제 기능 요구사항

```
기능명: 급여 세금/공제 계산
우선순위: P1

요구사항:
1. 공제 항목
   - 국민연금 (4.5%)
   - 건강보험 (3.545%)
   - 장기요양보험 (건강보험의 12.95%)
   - 고용보험 (0.9%)
   - 소득세 (간이세액표 기준)
   - 지방소득세 (소득세의 10%)

2. 설정 옵션
   - 공제 적용 여부 (정규직/계약직 구분)
   - 비과세 항목 설정 (식대, 차량유지비 등)

3. 출력
   - 총 지급액
   - 공제 합계
   - 실수령액

4. 급여 명세서
   - PDF 생성
   - 이메일 발송 (선택)
```

### 6.3 급여 계산 흐름

```
현재 흐름:
1. 월간 PT 실적 집계 (MonthlyStatsViewer)
   - schedules 테이블에서 통계 추출

2. 급여 템플릿 적용 (SalaryCalculator)
   - 직원별 할당된 템플릿 로드
   - 규칙별 금액 계산

3. 결과 저장 (calculated_salaries)
   - breakdown JSON에 상세 내역 저장

개선 필요:
- 월간 보고서 승인 후에만 급여 계산 가능하도록
- 승인된 스케줄만 집계에 포함
```

---

## 7. 매출/정산 관리 (Sales)

### 7.1 현재 구현 상태: 🔄 부분 구현 (40%)

#### 구현된 기능
| 기능 | 상태 | 설명 |
|------|------|------|
| 회원권 판매 기록 | ✅ | member_payments 테이블에 자동 저장 |
| 판매 로그 | ✅ | sales_logs 테이블 기록 |
| 대시보드 매출 표시 | ✅ | 당월 매출, 기간별 평균 |

#### 미구현 기능
| 기능 | 우선순위 | 설명 |
|------|----------|------|
| 매출 상세 조회 | 🎯 P1 | 기간별, 상품별, 직원별 매출 필터링 |
| 결제 수단별 집계 | 🎯 P1 | 카드/현금/계좌이체 구분 통계 |
| 환불 처리 | 🎯 P1 | 부분/전체 환불, 환불 기록 |
| 미수금 관리 | P2 | 미결제 내역 추적 |
| 매출 목표 관리 | P2 | 지점/직원별 목표 설정 및 달성률 |
| 정산 리포트 | P2 | 일별/주별/월별 정산표 |

### 7.2 매출 관리 페이지 요구사항

```
기능명: 매출 관리 페이지
우선순위: P1
위치: /admin/sales

요구사항:
1. 매출 현황 대시보드
   - 오늘 매출
   - 당월 누적 매출
   - 전월 동기간 대비
   - 상품 유형별 비율 차트

2. 매출 내역 테이블
   - 날짜, 회원명, 상품명, 금액, 결제수단, 담당자
   - 기간 필터 (오늘/이번주/이번달/커스텀)
   - 상품 유형 필터
   - 담당자 필터
   - Excel 내보내기

3. 환불 처리
   - 결제 내역에서 환불 버튼
   - 부분 환불 금액 입력
   - 환불 사유 기록
   - 회원권 잔여 횟수 조정

4. 정산
   - 결제수단별 일일 정산
   - PG사 정산 내역 비교 (선택)
```

---

## 8. 대시보드/통계 (Dashboard)

### 8.1 현재 구현 상태: 🔄 부분 구현 (50%)

#### 구현된 기능
| 기능 | 상태 | 설명 |
|------|------|------|
| PT회원 현황 통계 | ✅ | 전체/활성/유령회원 수 |
| 월별 매출 조회 | ✅ | 당월 및 최근 12개월 |
| 오늘의 일정 | ✅ | 당일 스케줄 요약 |
| 최근 등록 기록 | ✅ | 신규/재등록/부가상품 목록 |
| 지점 공지사항 | ✅ | 공지 표시 |
| 회사 이벤트 달력 | ✅ | 이벤트 캘린더 |

#### 미구현/개선 필요 기능
| 기능 | 우선순위 | 설명 |
|------|----------|------|
| PT회원 현황 통계표 개선 | 🎯 P1 | 상세 통계 테이블 뷰 |
| 매출 추이 차트 | 🎯 P1 | 라인/바 차트로 트렌드 시각화 |
| 회원 증감 통계 | P2 | 신규/이탈 회원 추이 |
| 트레이너 실적 순위 | P2 | PT 횟수/매출 기준 랭킹 |
| BEP 달성률 | P2 | 손익분기점 대비 현황 |
| 커스텀 위젯 | P3 | 사용자 정의 대시보드 구성 |

### 8.2 PT회원 현황 통계표 개선 요구사항

```
기능명: PT회원 현황 통계표
우선순위: P1

현재 상태:
- PTStatsCard 컴포넌트에 기본 통계 표시
- 카드 형태의 간단한 수치만 표시

개선 요구사항:
1. 상세 통계 테이블 추가
   - 트레이너별 담당 회원 수
   - 트레이너별 주간/월간 PT 횟수
   - 트레이너별 PT 회원 만료 예정자

2. 시각화 추가
   - 회원 상태별 파이 차트
   - 월별 PT 횟수 추이 라인 차트
   - 트레이너별 실적 바 차트

3. 필터링
   - 기간 선택 (주간/월간/분기)
   - 트레이너 선택

4. 내보내기
   - Excel 다운로드
   - PDF 리포트
```

---

## 9. 본사/시스템 관리

### 9.1 현재 구현 상태: ✅ 대부분 완료 (85%)

#### 구현된 기능 (HQ 관리)
| 기능 | 상태 | 설명 |
|------|------|------|
| 지점 목록 조회 | ✅ | 소속 지점 전체 조회 |
| 지점 생성/수정 | ✅ | 지점 정보 관리 |
| 직원 관리 | ✅ | 전 지점 직원 조회/수정 |
| 직원 지점 할당 | ✅ | 직원을 다른 지점으로 이동 |
| 회사 이벤트 | ✅ | 전사 이벤트/공지 관리 |
| BEP 설정 | ✅ | 지점별 손익분기점 설정 |

#### 구현된 기능 (System 관리)
| 기능 | 상태 | 설명 |
|------|------|------|
| 회사 목록 조회 | ✅ | 전체 회사 조회 (system_admin) |
| 회사 상태 관리 | ✅ | pending/active/suspended 상태 변경 |
| 시스템 공지 | ✅ | 전체 사용자 공지 관리 |
| DB 마이그레이션 | ✅ | SQL 마이그레이션 실행 |

---

## 10. 개발 로드맵

### Phase 1: 핵심 기능 완성 (우선순위 P1)

```
목표: 기본 운영에 필요한 핵심 기능 완성

1. 회원권 양도 기능
   - 양도 모달 UI
   - API 엔드포인트
   - 활동 로그 기록

2. 월간 보고서 시스템
   - 강사 제출 UI
   - 관리자 승인 UI
   - 스케줄 잠금 처리

3. 매출 관리 페이지
   - 매출 내역 테이블
   - 필터링/검색
   - 환불 처리

4. 급여 세금/공제
   - 4대보험 계산
   - 소득세 계산
   - 급여 명세서 PDF

5. 대시보드 통계 개선
   - PT회원 현황 테이블
   - 매출 추이 차트
```

### Phase 2: 운영 효율화 (우선순위 P2)

```
목표: 운영 편의성 및 분석 기능 강화

1. 급여 시스템 고도화
   - 전월 비교 분석
   - FC 레벨 시스템
   - 서버사이드 계산 API

2. 스케줄 개선
   - 반복 스케줄
   - 충돌 감지

3. 매출 분석
   - 미수금 관리
   - 매출 목표 관리
   - 정산 리포트

4. 대시보드 확장
   - 회원 증감 통계
   - 트레이너 실적 순위
   - BEP 달성률
```

### Phase 3: 고급 기능 (우선순위 P3)

```
목표: 확장성 및 사용자 경험 개선

1. 회원 포털
   - 회원 전용 앱/웹
   - 본인 출석 확인
   - PT 예약

2. 알림 시스템
   - 푸시 알림
   - SMS 연동
   - 이메일 알림

3. 고급 리포트
   - 커스텀 리포트 빌더
   - 자동 리포트 발송

4. 성능 최적화
   - 대량 데이터 처리
   - 캐싱 시스템
```

---

## 11. 데이터베이스 테이블 참조

### 핵심 테이블
| 테이블 | 용도 | 상태 |
|--------|------|------|
| companies | 회사 정보 | ✅ 사용 중 |
| gyms | 지점 정보 | ✅ 사용 중 |
| staffs | 직원 정보 | ✅ 사용 중 |
| members | 회원 정보 | ✅ 사용 중 |
| membership_products | 회원권 상품 | ✅ 사용 중 |
| member_memberships | 회원권 (구매) | ✅ 사용 중 |
| member_payments | 결제 내역 | ✅ 사용 중 |
| schedules | 스케줄 | ✅ 사용 중 |
| attendances | 출석 기록 | ✅ 사용 중 |
| monthly_schedule_reports | 월간 보고서 | 🔄 부분 사용 |
| calculated_salaries | 계산된 급여 | ✅ 사용 중 |
| salary_templates | 급여 템플릿 | ✅ 사용 중 |
| salary_rules | 급여 규칙 | ✅ 사용 중 |
| staff_salary_settings | 직원 급여 설정 | ✅ 사용 중 |
| member_activity_logs | 회원 활동 로그 | ✅ 사용 중 |

### 미사용/부분 사용 테이블
| 테이블 | 용도 | 상태 |
|--------|------|------|
| job_positions | 직무 정의 | ❌ 미사용 |
| salary_components | 급여 구성요소 | 🔄 참조만 |
| calculation_rules | 계산 규칙 (레거시) | ❌ 새 시스템으로 대체 |
| fc_level_assignments | FC 레벨 | ❌ 미사용 |
| monthly_performances | 월별 실적 | 🔄 부분 사용 |

---

## 12. API 엔드포인트 현황

### 회원 관리
```
GET/POST   /api/admin/members
GET/PUT/DELETE /api/admin/members/[id]
GET        /api/admin/members/[id]/detail
PUT/DELETE /api/admin/members/[id]/membership
POST       /api/admin/members/[id]/membership/hold
PUT/DELETE /api/admin/members/[id]/addon
POST       /api/admin/members/[id]/sales
```

### 스케줄/출석
```
GET/POST   /api/admin/schedule/events
PUT/DELETE /api/schedule/[id]
POST       /api/schedule/submit
POST       /api/schedule/approve
POST       /api/schedule/update-status
GET        /api/attendance/records
POST/DELETE /api/attendance/records/[id]
```

### 급여
```
GET/POST   /api/salary
GET/PUT    /api/salary/[id]
```

### 시스템
```
GET        /api/admin/dashboard/stats
POST       /api/admin/create-staff
POST       /api/admin/create-branch
PUT        /api/admin/update-branch
GET        /api/admin/hq/data
POST       /api/admin/system/update-company
```

---

## 13. 참고 문서

- [ERD.md](ERD.md) - 데이터베이스 구조
- [docs/DESIGN_SYSTEM.md](docs/DESIGN_SYSTEM.md) - 디자인 시스템
- [docs/SALARY_SYSTEM_SETUP.md](docs/SALARY_SYSTEM_SETUP.md) - 급여 시스템 설정
- [docs/TEST_ACCOUNTS.md](docs/TEST_ACCOUNTS.md) - 테스트 계정 정보

---

## 변경 이력

| 날짜 | 버전 | 변경 내용 |
|------|------|----------|
| 2025-12-30 | 1.0 | 초기 PRD 작성 |
