# 0. Collaboration Guidelines (협업 수칙)
#
# - Critical Preservation:
#   기존에 구현된 핵심 기능(로그인, 지점 관리, 스케줄러 등)을 삭제하거나 변경할 때는
#   반드시 사용자에게 사이드 이펙트(부작용)를 경고하고 동의를 구할 것.
# - Proactive Suggestion:
#   사용자의 요청보다 더 효율적이거나 안전한 아키텍처(보안, 확장성 고려)가 있다면 즉시 제안할 것.
# - Full Context:
#   코드 수정 시, 사용자가 복사/붙여넣기 실수를 하지 않도록
#   가급적 '전체 파일 코드'를 제공하는 것을 기본으로 할 것.
# - Error Handling:
#   에러 발생 시, 막연한 추측보다 로그(console.log)를 추가하여
#   원인을 파악하는 코드를 먼저 제안할 것.
#
# (아래부터는 기존 프로젝트 규칙)

# Project: We:form (Sports Center ERP SaaS)

Sports center(헬스장/필라테스/센터 등) 운영 전반을 관리하는 **ERP SaaS** 프로젝트이다.  
회원 관리, 강사 스케줄, 급여 정산, 외부 연동(n8n, 구글 시트 등)을 **한 곳에서** 관리하는 것이 핵심 목표다.

---

## 1. Identity & Design (브랜드 & 디자인 시스템)

- **Brand Name**: We:form
- **Primary Color (브랜드 메인)**: Bright Blue `#2F80ED`
- **Accent / Point Color (강조)**: Orange `#F2994A`
- **Style**: Clean, Minimal, Bento Grid, Data-Centric
- **UI Library**: Shadcn UI + Tailwind CSS (Tailwind v4)

### 1-1. UI/UX 원칙

- **모바일 우선(Mobile First)**: 강사용 화면(`/staff/*`)은 모바일 해상도 기준으로 먼저 설계한다.
- **데이터 우선(Data-Centric)**: 차트/카드/리스트를 통해 "한 눈에 이해 가능한" 데이터 표현을 지향한다.
- **일관된 색 사용**:
  - 메인 배경/헤더/사이드바: Primary Blue (`#2F80ED`)
  - Call-to-Action 버튼: Accent/Point Orange (`#F2994A`) + **흰색 또는 진한 텍스트, 굵게**

---

## 2. Tech Stack (기술 스택)

- **Framework**: Next.js 14+ (App Router)
- **Language**: TypeScript
- **Database**: Supabase (PostgreSQL)
- **Auth**: Supabase Auth
- **State**: TanStack Query (React Query) – 서버 상태 관리에 사용
- **Scheduler**: FullCalendar (React)
  - Plugins: `dayGrid`, `timeGrid`, `interaction`, `list`
- **UI Components**: Shadcn UI (Button, Card, Input, Label, Dialog 등)

---

## 3. Key Architecture Rules (DO NOT BREAK)

### 3-1. 멀티 테넌시 (Multi-tenancy)

- 모든 주요 도메인 테이블에는 **반드시 `gym_id` 컬럼이 있어야 한다.**
- 모든 DB 조회/수정 쿼리에는 `where gym_id = ?` 필터가 들어가야 한다.
- RLS 정책에서도 `gym_id` + `staffs` 테이블을 통해 권한을 강제한다.

### 3-2. 라우팅 규칙

- `/login` : 진입점(로그인 페이지)
- `/staff/*` : 강사용 모바일 뷰
  - 예: `/staff` (오늘의 스케줄 리스트), 향후 `/staff/profile`, `/staff/history` 등
- `/admin/*` : 관리자용 데스크톱 대시보드
  - 예: `/admin` (운영 현황 대시보드), `/admin/payroll`, `/admin/settings` 등

### 3-3. 급여 & 스케줄 관련 핵심 정책

- **스케줄 수정 권한**
  - Staff(강사)는 **"현재 달(Current Month)"에 속한 자신의 스케줄만** 생성/수정할 수 있다.
  - 과거 달(지난 달 포함)의 스케줄 수정은 **Admin 승인/수정만 허용**한다.
- **상태(Status) 코드**
  - `completed` (녹색)       : 출석 완료
  - `no_show_deducted` (빨강): 노쇼(공제 대상)
  - `no_show` (회색)         : 단순 노쇼
  - `service` (파랑)         : 서비스 / 무료 수업
- **상태 설정/매핑**
  - 상태 코드는 **테이블(`attendance_statuses`) + 설정 테이블(`salary_settings`)** 로 관리한다.
  - 프론트엔드에 상태 로직을 하드코딩하지 말고, **DB 설정을 읽어서** 의미/색상/급여 규칙을 반영한다.

### 3-4. DB 스키마 규칙

- `staffs` 테이블:
  - `job_title` (직책), `employment_status` (`'재직'`, `'퇴사'`, `'가입대기'` 등), `phone`, `joined_at`, `email` 컬럼을 **반드시 관리**한다.
  - 신규 기능 추가 시 이 필드들을 기준으로 권한/승인/필터링 로직을 설계한다.
- `gyms` 테이블:
  - `status` 컬럼으로 센터 승인 상태를 관리한다. (`'active'`, `'pending'` 등)
  - 로그인/접근 제어 시 이 값을 함께 확인한다.

---

## 4. Coding Behavior (코딩 스타일 & AI 행동 강령)

- **함수형 컴포넌트 + Hooks** 만 사용 (클래스형 컴포넌트 사용 금지).
- **RLS 우선**:
  - SQL/쿼리 설계 시 항상 **Row Level Security 정책**을 고려한다.
  - Supabase RLS 정책이 존재하지 않으면 먼저 정의하는 것을 우선시한다.
- **비즈니스 로직 하드코딩 금지**:
  - 급여 규칙, 상태 매핑, 권한 로직 등은 **DB의 설정 테이블**(예: `salary_settings`, `attendance_statuses`)로 관리한다.
- **명시적 타입 사용**:
  - TypeScript에서 `any` 사용은 최소화하고, 도메인 타입(`ScheduleStatus`, `StaffRole` 등)을 정의해 사용한다.
- **UX 친절성**:
  - 에러 메시지는 **한국어**로, 사용자가 이해하기 쉬운 문장으로 안내한다.
  - 로딩/저장 중 상태(스피너, "저장 중..." 텍스트 등)를 명확히 표시한다.

### 4-1. 보안 규칙

- 로그인 시:
  - `staffs.employment_status === '퇴사'` 이면 즉시 로그아웃 처리하고, 이용 제한 안내 메시지를 보여준다.
  - `gyms.status === 'pending'` 인 센터 소속 직원도 로그인 직후 세션을 종료하고, "가입 승인 대기" 안내를 보여준다.
- 직원 생성/가입 관련 API:
  - `SUPABASE_SERVICE_ROLE_KEY` (Service Role)로 생성한 **서버 전용 Supabase 클라이언트**만 사용한다.
  - 클라이언트(브라우저)에서는 절대 Service Role 키를 사용하지 않는다.

---

## 5. AI 사용 정책 (Cursor / AI Agent Guideline)

- 사용자의 **역할/권한 규칙(강사/관리자)** 을 항상 존중하는 방향으로 제안할 것.
- Supabase, Shadcn, FullCalendar 등 **공식 가이드**와 최대한 일치하게 설정/예제를 구성할 것.
- 사용자에게 `pnpm run dev` 같은 서버 실행 명령은 **직접 실행하도록 안내만** 하고, 도구로는 실행하지 않는다.
- 한국어를 기본 응답 언어로 사용하고, 비개발자도 이해할 수 있게 **쉬운 설명**을 우선한다.

---

## 6. n8n & FullCalendar 연동 규칙

### 6-1. n8n 연동 규칙

- 클라이언트(브라우저)에서 n8n으로 직접 요청하지 않는다.  
  CORS 및 보안 문제 방지를 위해 반드시 `src/app/api/n8n/route.ts` 를 경유하는 **Proxy 패턴**으로 통신한다.
- n8n Webhook 주소는 코드에 하드코딩하지 않고, `.env.local` 의 `N8N_WEBHOOK_URL` 환경 변수를 사용한다.
- n8n 연동 실패 시:
  - 콘솔에만 로그를 남기고, 사용자 UX는 최대한 방해하지 않는다(특히 강사 앱에서 수업 등록 시).

### 6-2. FullCalendar 규칙

- **한국어 설정 필수**:  
  - `koLocale` 을 사용해 캘린더 언어를 한국어로 설정한다.
- **번역/자동 번역 오류 방지**:
  - FullCalendar 최상위 컨테이너에 `notranslate` 클래스를 부여해, 브라우저/번역 플러그인의 오작동을 방지한다.
- **모바일 강사 화면(`/staff`) 규칙**:
  - 기본 뷰는 항상 `listWeek` 로 설정한다 (주간 리스트 뷰).
  - 우측 하단에 **FAB(Floating Action Button)** 을 두고, 이를 통해 수업/일정 추가 모달을 연다.
- **데이터 포맷 규칙**:
  - 외부 전송(n8n, 구글 시트 등) 시 강사명/지점명 등 식별자는  
    `지점명_이름` 형태로 가공해서 전송한다. (예: `강남_김코치`, `판교_이트레이너`) — 강사명 전송 시 이 포맷을 반드시 유지한다.
  - 상태(status) 코드는 DB에서 관리하는 코드값(`completed`, `no_show_deducted` 등)을 그대로 사용하고,  
    n8n/시트 쪽에서 이 코드에 맞춰 후처리하도록 설계한다.


