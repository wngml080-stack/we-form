# We:form 프로젝트 종합 평가 보고서

> 작성일: 2025-01-XX  
> 평가 범위: 전체 프로젝트 구조, 코드 품질, 보안, 아키텍처

---

## 📊 평가 요약

| 항목 | 점수 | 상태 |
|------|------|------|
| **아키텍처 설계** | 7/10 | ⚠️ 개선 필요 |
| **보안** | 6/10 | ⚠️ 개선 필요 |
| **코드 품질** | 5/10 | 🔴 개선 필요 |
| **유지보수성** | 5/10 | 🔴 개선 필요 |
| **규칙 준수** | 6/10 | ⚠️ 개선 필요 |

**종합 점수: 5.8/10** - 기본 구조는 갖춰져 있으나, 리팩토링과 보안 강화가 필요합니다.

---

## 🔴 심각한 문제점 (즉시 수정 필요)

### 1. **Supabase 클라이언트 중복 생성 (73개 파일)**

**문제:**
- 거의 모든 페이지에서 `createBrowserClient` 또는 `createClient`를 직접 호출
- 코드 중복이 심각하고, 유지보수가 어려움
- 환경 변수 체크가 없어 런타임 에러 가능성

**영향:**
- 환경 변수가 없으면 앱 전체가 깨짐
- 클라이언트 인스턴스 관리가 비효율적
- 테스트 작성이 어려움

**해결 방안:**
```typescript
// src/lib/supabase/client.ts (새로 생성 필요)
// src/lib/supabase/server.ts (이미 있지만 개선 필요)
```
- 클라이언트용 유틸리티 함수를 만들어서 재사용
- 환경 변수 검증 로직 추가

---

### 2. **로그인 시 `gyms.status === 'pending'` 체크 누락**

**문제:**
- `.cursorrules` 규칙에는 명시되어 있음: "`gyms.status === 'pending'` 인 센터 소속 직원도 로그인 직후 세션을 종료"
- 실제 코드(`src/app/login/page.tsx`)에는 구현되지 않음

**현재 코드:**
```typescript
// 퇴사자만 체크하고 있음
if (staffData.employment_status === '퇴사') {
  await supabase.auth.signOut();
  throw new Error("퇴사 처리된 계정입니다.");
}
// ❌ gyms.status 체크가 없음!
```

**해결 방안:**
- 로그인 시 `gyms` 테이블 조회하여 `status === 'pending'` 체크 추가
- 승인 대기 센터 소속 직원은 로그인 차단

---

### 3. **환경 변수 파일 누락**

**문제:**
- `.env.local` 또는 `.env.example` 파일이 없음
- 프로젝트를 새로 받은 사람이 어떤 환경 변수가 필요한지 알 수 없음
- 환경 변수 검증 로직이 없어 런타임에만 에러 발견

**필요한 환경 변수:**
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`
- `N8N_WEBHOOK_URL`

**해결 방안:**
- `.env.example` 파일 생성
- 환경 변수 검증 유틸리티 함수 추가

---

### 4. **타입 안정성 문제**

**문제:**
- `any` 타입 사용이 많음 (예: `catch (err: any)`)
- `@ts-ignore` 주석 사용 (예: `src/app/admin/attendance/page.tsx:112`)
- 도메인 타입 정의가 부족

**영향:**
- 타입 에러를 런타임에만 발견
- IDE 자동완성 지원이 약함
- 리팩토링 시 실수 가능성 증가

**해결 방안:**
- `src/types/` 폴더에 도메인 타입 정의
- `any` 대신 구체적인 타입 사용
- `@ts-ignore` 제거하고 타입 정의 보완

---

## ⚠️ 개선이 필요한 문제점

### 5. **TanStack Query 미사용**

**문제:**
- `.cursorrules`에는 "TanStack Query (React Query) – 서버 상태 관리에 사용"이라고 명시
- 실제로는 `package.json`에 없고, 사용하지 않음
- 모든 데이터 페칭이 `useEffect` + `useState`로 처리됨

**영향:**
- 캐싱, 리프레시, 에러 핸들링이 수동으로 처리됨
- 중복 요청이 많아질 수 있음
- 로딩 상태 관리가 일관되지 않음

**해결 방안:**
- TanStack Query 설치 및 적용
- 또는 규칙에서 제거하고 현재 방식 유지

---

### 6. **RLS 정책 적용 상태 불명확**

**문제:**
- RLS 정책이 `_archive/scripts/apply-rls-policies.sql`에만 있음
- 마이그레이션 파일(`supabase/migrations/`)에는 일부만 포함
- 실제 DB에 적용되었는지 확인 어려움

**해결 방안:**
- 모든 RLS 정책을 마이그레이션 파일로 이동
- 마이그레이션 실행 상태 확인 스크립트 작성

---

### 7. **에러 핸들링 일관성 부족**

**문제:**
- 일부는 `alert()` 사용 (예: `src/app/admin/attendance/page.tsx:108`)
- 일부는 에러 메시지 상태로 표시
- 일부는 콘솔만 출력하고 사용자에게 알리지 않음

**해결 방안:**
- 공통 에러 핸들링 컴포넌트/유틸리티 생성
- 에러 메시지 표시 방식 통일

---

### 8. **루트 페이지(`/`) 미구현**

**문제:**
- `src/app/page.tsx`가 Next.js 기본 템플릿 그대로
- 로그인 페이지로 리다이렉트하거나, 랜딩 페이지로 사용해야 함

**해결 방안:**
- 로그인 페이지로 자동 리다이렉트
- 또는 브랜드 소개 랜딩 페이지 구현

---

### 9. **코드 중복: 데이터 페칭 로직**

**문제:**
- 여러 페이지에서 유사한 데이터 페칭 패턴 반복
- 예: `fetchMembers`, `fetchSchedules`, `fetchStaffs` 등이 여러 파일에 중복

**해결 방안:**
- 커스텀 훅으로 추출 (예: `useMembers`, `useSchedules`)
- 또는 TanStack Query로 통일

---

## ✅ 잘 구현된 부분

### 1. **멀티 테넌시 구조**
- `gym_id` 필터링이 대부분의 쿼리에 적용됨
- RLS 정책 설계가 잘 되어 있음 (아직 적용 여부 확인 필요)

### 2. **보안: Service Role 키 사용**
- 클라이언트에서 Service Role 키를 사용하지 않음
- API 라우트에서만 Service Role 사용

### 3. **n8n 연동 패턴**
- Proxy 패턴으로 올바르게 구현됨
- 에러 발생 시 UX를 해치지 않도록 처리

### 4. **프로젝트 구조**
- Next.js App Router 구조가 잘 정리됨
- `/admin/*`, `/staff/*` 라우팅 규칙 준수

---

## 📋 우선순위별 개선 작업

### 🔥 긴급 (1주일 내)
1. ✅ Supabase 클라이언트 유틸리티 함수 생성 및 적용
2. ✅ 로그인 시 `gyms.status` 체크 추가
3. ✅ `.env.example` 파일 생성
4. ✅ 환경 변수 검증 로직 추가

### ⚠️ 중요 (2주일 내)
5. ✅ 타입 정의 보완 (`any` 제거, 도메인 타입 추가)
6. ✅ 에러 핸들링 통일
7. ✅ RLS 정책 마이그레이션 확인 및 적용
8. ✅ 루트 페이지 리다이렉트 구현

### 📝 개선 (1개월 내)
9. ✅ TanStack Query 도입 또는 규칙 수정
10. ✅ 데이터 페칭 로직 커스텀 훅으로 추출
11. ✅ 코드 중복 제거
12. ✅ 테스트 코드 작성 (선택)

---

## 🎯 결론

프로젝트의 **기본 구조와 아키텍처 설계는 잘 되어 있습니다**. 특히 멀티 테넌시 구조와 보안 설계가 체계적입니다.

하지만 **코드 품질과 유지보수성 측면에서 개선이 필요**합니다. 특히:
- 코드 중복이 심각함
- 타입 안정성이 부족함
- 환경 설정이 불명확함

**권장 사항:**
1. 먼저 긴급 항목부터 해결하여 안정성 확보
2. 점진적으로 리팩토링 진행
3. 새로운 기능 추가 전에 기존 코드 정리

---

## 📚 참고 자료

- 프로젝트 규칙: `.cursorrules`
- ERD 문서: `ERD.md`
- 마이그레이션: `supabase/migrations/`

